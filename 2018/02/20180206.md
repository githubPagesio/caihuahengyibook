# 20180206

**肖威工作总结**
- 上午：阿里云部署实战
- 下午：阿里云部署总结
- 晚上：阿里云部署思考

Linux 云服务器部署运维
http://wangjiao-blog.logdown.com/posts/2260929-linux-cloud-server-deployment-operation-and-maintenance

数一数教材《部署指南》上的坑，写给后来者………….XD.md
http://activeliang-blog.logdown.com/posts/1652386-dry

[SDE] Ubuntu server搭配Nginx-Passenger部署RoR App

本次部署組合 Passenger + Nginx + Ubuntu 12.04
為什麼挑這個組合呢....因為他的步驟看起來最少....

前一篇為 [SDE] windows上使用虛擬機架設Ubuntu server
這部分筆記是為了快速部署 單一 server使用，如果說你有多台server需部署
請搜尋Capstrino或是Mina這類專業的部署工具

創建Ubuntu使用者
這一步其實可以看自身需求要不要做，因為linux是個相當重視 權限的一個系統
我的考量是創立一個新的user來做deploy，這樣如果其他使用者有用的話也不會有干擾
我們ssh連線進入server中，如果你不知道怎麼ssh連線的話，
這篇文章最開頭有提示前一篇，裡面有提到一點，可以參考。

接著我們創立一個新的user 叫做deploy，顧名思義

$ sudo adduser deploy
$ sudo adduser deploy sudo
接著我們切換使用者，換成deploy的身份登入
或是用下面的指令更替用戶。

$ su deploy
先安裝會用到的軟體
先確保資料都在最新的情況下

$ sudo apt-get update
安裝前置所需軟體，會跑一段時間，小小等待。

$ sudo apt-get install git-core curl zlib1g-dev build-essential libssl-dev libreadline-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt1-dev libcurl4-openssl-dev python-software-properties
Install RVM & Ruby
安裝rvm
這一步可以選擇用rbenv或是rvm，因為習慣所以我選擇rvm，先安裝一些必要的東西

$ sudo apt-get install libgdbm-dev libncurses5-dev automake libtool bison libffi-dev
接著開始安裝rvm

$ curl -L https://get.rvm.io | bash -s stable
$ source ~/.rvm/scripts/rvm
$ echo 'gem: --no-ri --no-rdoc'  >> ~/.gemrc
$ echo "source ~/.rvm/scripts/rvm" >> ~/.bashrc
出現下圖即為完成！



安裝ruby
接著利用rvm安裝ruby，此處選擇安裝這時的最新版本2.1.2，並將它設為預設使用

$ rvm install 2.1.2
$ rvm use 2.1.2 --default
安裝完之後，$ ruby -v檢查版號是否安裝完成

$ ruby -v
ruby 2.1.2p95 (2014-05-08 revision 45877) [i686-linux]
OK，往下一步前進。

安裝Nginx & Passenger
Passenger部分
gem install passenger
Nginx部分
安裝Nginx的passenger模組

rvmsudo passenger-install-nginx-module
這邊簡單來說就是全部選擇預設，如果有缺什麼他會提醒你記得下載
Nginx的安裝目錄預設就是/opt/ngin/

歡迎光臨，請按enter繼續
歡迎光臨，請按enter繼續

請選擇Ruby
請選擇Ruby

它會自動幫你確認是否該裝的都有裝
它會自動幫你確認是否該裝的都有裝

懶人方法，全部都幫我裝謝謝！選1
懶人方法，全部都幫我裝謝謝！選1

按enter繼續，以預設值安裝
按enter繼續，以預設值安裝

裝完成功囉
裝完成功囉

等等會改到的地方，看一看就可以跳過了
等等會改到的地方，看一看就可以跳過了

到此算安裝完成
接著需要用到nginx啟動腳本這個東西
因為老實說我還不知道是什麼，所以就先暫且用中國專家chloerei提供的腳本

$ cd /etc/init.d
$ sudo wget https://raw.github.com/chloerei/nginx-init-ubuntu-passenger/master/nginx
記得要跑到100%才算成功，有的時候會出錯...
記得要跑到100%才算成功，有的時候會出錯...

$ sudo update-rc.d nginx defaults
$ sudo chmod +x nginx
接著我們嘗試運行Nginx

$ sudo service nginx start
 * Starting Nginx Server...                                                     [ OK ]
到此，如果在瀏覽器輸入主機ip，應該就能看到nginx的歡迎畫面，如下圖

Welcome to Nginx!
Welcome to Nginx!

我們的Nginx之後可以用

$ sudo service nginx start啟動
$ sudo service nginx stop停止
$ sudo service nginx restart重新啟動

Fix the conf
接著修改設定，設定檔是/opt/nginx/conf/nginx.conf，看你要用什麼工具修改都可
只是它原本是設定readonly，所以記得在前面加上 sudo！
打開來會看到密密麻麻一大串，我們找到中間server的部分，進行修改

server {
  listen 80;
  server_name localhost;
  root /home/deploy/testapp/public;   #加入這行
  passenger_enabled on;               #跟這行
}
後面有個location的部分在每一行行首加入#全部註解掉

#location / {
#    root   html;
#    index  index.html index.htm;
# }
首先我們看到server設定的部分，listen主要為server監聽的port，
照理來說都是80，如果你跟我一樣用虛擬機有設定自定的port則要改成你自定的

server_name可以填你的domain，網域名稱，不然放著localhost也行
root這行很重要，他 必須 指向你Rails App的Public資料夾
上面我寫的設定就是，我的rails app名稱為testapp，放在deploy下面。

Install Database (PostgreSQL)
安裝資料庫，因為我是使用postgresql，所以就拿這個來說明

$ sudo apt-get install postgresql postgresql-contrib
安裝完畢之後進入DB中建立role

$ sudo -u postgres psql
psql (9.1.13)
Type "help" for help.
postgres=# create user deploy createdb createuser;
CREATE ROLE
postgres=# \q
建立完畢！
現在這個情況的話，連到server會呈現錯誤的狀態
但是已經可以看到是rails的錯誤畫面了！！

Bundle Install
check all gem
首先，如果你是使用postgresql的話請先安裝這個，不然會無法安裝使用pg gem

$ sudo apt-get install libpq-dev
然後cd進你的app資料夾中，在Gemfile中找到一個叫做therubyracer
他預設是註解掉的，請將它取消註解，因為我們之後會用到它

接著$ bundle install
沒意外的話是會順利跑完的，如果有錯誤訊息的話通常會提示還需要安裝什麼
不用太擔心！

最後

$ RAILS_ENV=production rake db:create
$ RAILS_ENV=production rake db:migrate
之後重啟passenger跟nginx

$ touch tmp/restart.txt
$ sudo service nginx restart
Success!
沒意外的話，連到server就會出現你部署的網頁囉
下面是兩個檢視找尋錯誤的方法

檢視nginx Error Log$ tail -f /opt/nginx/logs/error.log
檢視passenger log $ tail -f log/production.log

After deploy 20140617新增
New Project
如果想要換一個網站的話，可以直接修改nginx.conf的root路徑，在重新啟動即可。

New Rails
使用新版的Rails，所產生的database.yml可能會與之前的不太相同，
一樣要注意的是production的設定

production:
    <<: *default
  database: testapp_production
  username: deploy
Could not find a JavaScript ...
$ rake db:create
rake aborted!
ExecJS::RuntimeUnavailable: Could not find a JavaScript runtime....
需要nodejs或是therubyracer

config/secrets.yml
資料庫都建好了，結果nginx報錯，進到$ tail -f /opt/nginx/logs/error.log
如果看到下列

Exception RuntimeError in Rack application object (Missing `secret_key_base` for 'production' environment, set this value in `config/secrets.yml
這似乎是4.1版之後才會出現，重點在config/secrets.yml，你可進去裡面看，
會發現除了production之外其他兩個狀態都有類似密鑰的東西
用$ rake secret生成之後再放入config/secrets.yml中即可，
如果是local端，不用修改只接用bash_profile設定即可

~/.bash_profile
export SECRET_KEY_BASE="RAKE_SECRET_RESULT"
same command
一個新的project一樣要執行過這些，資料庫的name也要設定
assets:precompile沒做的話也可以，只是網站只會出現純文字，沒有js css 跟圖片
修改的話除非動到assets，不然直接niginx重啟即可。

$ RAILS_ENV=production rake db:create  # 生成DB
$ RAILS_ENV=production rake db:migrate  # migrate
$ RAILS_ENV=production bundle exec rake assets:precompile  #很重要
$ sudo service nginx restart #記得重啟
Reference
大兜 - 大兜本人
GoRails - Deploy Ruby On Rails on Ubuntu 12.04 Precise Pangolin (感謝泡芙)
joneslee85/ruby-journal-source - How to setup Rails app with puma and NGINX
Michael Hsu.tw - Nginx + Passenger + Rails4 Setup on Ubuntu12.04
@ChingHanHo - 如何佈署 Rails 應用程式到 Amazon EC2
RubyChina - Passenger/Nginx/Ubuntu快速部署Rails 3.1

部署rails於vagrant ubuntu 14 trusty with nginx + passenger using capistrano
http://sharefun.logdown.com/posts/712227-deploying-rails-on-ubuntu-14-trusty-with-nginx-passenger-using-capistrano

Part 1 虛擬環境設置
在這裡小卡關，因為機器沒有開啟Visualization，又因為一開始沒有在Vagrantfile裡打開virtualbox視窗的選項，所以看到錯誤訊息一直不明究理。總之，到BIOS設定開啟visualization後就好了。

參考資料

使用Vagrant + VirtualBox，使用ubuntu-trusty-64鏡像檔開啟後
vagrant ssh登入（預設會使用vagrant/vagrant登入）
因為user和ssh已經被Vagrant設定好了，這邊先跳過

之前用慣VirtaulBox的圖形介面，把Vagrant CLI與其相對應一下
vagrant init = 從image開新的vm
vagrant up = 開啟該vm
vagrant halt = 把該vm關機
vagrant destroy = 從VirtualBox移除該vm（image並不會移除）
vagrant box list = 看有那些image(box)
vagrant box remove _box_name_ = 移除特定image(box)

（Vagrant基礎說明 http://www.codedata.com.tw/social-coding/vagrant-tutorial-4-guest-host-communication/）

Part 2 更新
sudo apt-get update
sudo apt-get upgrade

Part 3 新增使用者sharefun
sudo adduser sharefun or sudo adduser --disabled-password sharefun
sudo passwd sharefun
sudo su # retrieve root
adduser sharefun sudo # make sharefun have sudo power
exit
sudo su sharefun # switch to sharefun

Part 4 ssh 登入
沒有公私鑰才使用下列指令
ssh-keygen -t rsa
複製本機的 ~/.ssh/id_rsa.pub 到機器的 /home/sharefun/.ssh/authorized_keys
cat ~/.ssh/id_rsa.pub | ssh sharefun@xxx.xxx.xxx.xxx 'cat >> ~/.ssh/authorized_keys'
chmod 644 /home/sharefun/.ssh/authorized_keys
chown sharefun:sharefun /home/sharefun/.ssh/authorized_keys

更改ssh登錄port，並拒絕密碼登入，在server的修改
sudo vi /etc/ssh/sshd_config

PasswordAuthentication no
執行sudo service ssh restart使之生效
如果之後搞壞.bashrc，導致登不進去（我就發生這個問題），可以在不跑.bashrc的情況登入（因為已經不能用密碼登入了）
ssh -t username@xxx.xxx.xxx.xxx /bin/sh

Part 5 裝機
這兩篇寫得蠻詳細的，本篇主要照這兩篇來做，並在下方輔助一些參考資料

（極客技術網 http://www.rails365.net/articles/bu-shu-zhi-zai-a-li-yun-ubuntu-zhu-ji-shang-an-zhuang-ruby-on-rails-huan-jing-liu）
（Ruby on Rails 實戰聖經部署篇 https://ihower.tw/rails4/deployment.html）
（xdite http://rails101s.logdown.com/posts/247891-project-deploy-on-the-server）

先裝git sudo apt-get install git
調整時區 sudo dpkg-reconfigure tzdata
安裝常用套件，以實戰聖經為基礎，新增一些常用的套件，包含nodejs, imagemagick, redis
// Build tool and library for ruby
sudo apt-get install build-essential zlib1g zlib1g-dev libssl-dev libreadline6-dev libyaml-dev git-core bison openssl curl libsqlite3-0 libsqlite3-dev sqlite3 autoconf libc6-dev libpcre3-dev curl libcurl4-nss-dev libxml2-dev libxslt-dev libffi-dev redis-server imagemagick nodejs ruby-dev liblzma-dev libgmp-dev

// Nodejs升到最新版4.x
curl -sL https://deb.nodesource.com/setup_4.x | sudo -E bash -
sudo apt-get install -y nodejs

// Install rvm and Ruby
gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3
\curl -sSL https://get.rvm.io | bash -s stable // 預設裝在使者目錄
\curl -sSL https://get.rvm.io | sudo bash -s stable // 裝在/usr/local/rvm

rvm install 2.3.0
rvm --default use 2.3.0
gem install bunlder --no-doc --no-ri
裝postgres
請見postgresql on ubuntu
安裝完發現無法啟動
sudo service postgresql start
發現錯誤訊息，是因為語系沒有先設定好，所以安裝過程出錯
* No PostgreSQL clusters exist; see "man pg_createcluster"
根據這篇繼續找原因 http://dba.stackexchange.com/questions/50906/why-wont-postgresql-9-3-start-on-ubuntu
sudo vi /etc/default/locale
加入三行

LANG="en_US.UTF-8"
LANGAUGE="en_US.UTF-8"
LC_ALL="en_US.UTF-8"
sudo dpkg-reconfigure locale
sudo pg_createcluster 9.3 main --start
再回去打第一條，打完收工~

裝Nginx + Passenger
移除系統預裝的nginx
sudo apt-get purge nginx nginx-full nginx-light nginx-naxsi nginx-common
sudo rm -rf /etc/nginx

gem install passenger --no-ri --no-rdoc
which passenger-install-nginx-module
rvmsudo 上面的輸出
碰到虛擬記憶體不足的問題，依建議輸入指令即可解決
驗證安裝是否成功
rvmsudo passenger-config validate-install
片尾有訊息說要改passenger和ruby的路徑，可用下列指令查詢，並在其下找passenger path
which ruby
which passenger

如果無法啟動rails server，出現這樣的訊息

The program 'rails' can be found in the following packages:

ruby-railties-3.2
ruby-railties-4.0 Try: sudo apt-get install
在.bashrc加入
source ~/.profile
[[ -s "$HOME/.rvm/scripts/rvm" ]] && source "$HOME/.rvm/scripts/rvm"

接著我們設定 Nginx 啟動腳本：

git clone git://github.com/jnstq/rails-nginx-passenger-ubuntu.git
sudo mv rails-nginx-passenger-ubuntu/nginx/nginx /etc/init.d/nginx
sudo chown root:root /etc/init.d/nginx
nginx操作

sudo service nginx start
sudo service nginx stop
sudo service nginx restart
sudo service nginx configtest
Part 6 用 Capistrano 部署 rails app
Capistrano在本機運行，它的工作是登入你的伺服器，進行一系列shell操作。
首先先在本地端安裝capistrano gem
gem install capistrano
然後在Gemfile中加上（實際上依applicatoin server的不同，下面會有所不同）

gem 'capistrano-rails', :group => :development
gem 'capistrano-passenger', :group => :development
在專案下執行初始化capistrano
cap install 會產生Capfile（基礎設施宣告，宣告會用到的外掛和自訂任務）, config/deploy.rb（全域變數設定檔，會被所有stage引用）, config/deploy/production.rb（不同的部署環境）, config/deploy/staging.rb（不同的部署環境）

基本上，Capfile裡面就有說明文檔的連結，可以知道怎麽設定deploy.rb。看這篇了解這些生出來的檔案都寫了些什麽

做 deploy 前的檢查，並把遠端 (production) 需要的資料夾建立，如果有 error 請檢查錯誤訊息去 debug
cap production deploy:check

把secret.yml, database.yml複製一份到server，並且使用rake secret得到本地端的secret_key_base，貼至server。
gitignore上述兩個檔案。

執行 deploy 程序正式運作自動化 deploy
cap production deploy

bundle exec passenger start
bundle exec passenger restart

passenger-config validate-install

passenger-status

passenger-config --root

If you want to restart using touch tmp/restart.txt, add this to your config/deploy.rb:
set :passenger_restart_with_touch, true

在第二台機器部署時，跑passenger錯誤：

/home/deploy/.rvm/rubies/ruby-2.3.0/lib/ruby/2.3.0/rubygems/specification.rb:2158:in `method_missing': undefined method `this' for #<Gem::Specification:0xcbfb74 passenger-5.0.27> (NoMethodError)
gem -v 可以看目前版本
是因為rubygem在2.5.1有問題，所以降版改為2.4.8
gem update --system 2.4.8 --no-ri --no-rdoc
ref

Part 7 第一次部署
bundle exec rake db:create RAILS_ENV=production
bundle exec rake db:migrate RAILS_ENV=production
RAILS_ENV=production passenger start

Production environment build up 其他參考資料
Passenger
https://www.phusionpassenger.com/library/

Rocodev
https://github.com/rocodev/guides/wiki

Ruby China
https://ruby-china.org/wiki/deployment-rails

其他
http://wulfric.me/2016/03/ruby-on-rails-on-aliyun/

Linode + capistrano
https://github.com/rocodev/guides/wiki/setup-production-development

Ruby China
https://ruby-china.org/topics/18616

Unicore + nginx
http://tech.gadii.net/blog/2013/03/07/rails-deploy-ji-chu-jiao-xue/

Nginx範例和說明
http://docs.bitshares.org/testnet/8-nginx.html
http://rexlnamp.blogspot.tw/2015/09/nginx.html
http://z00w00.blog.51cto.com/515114/1031287

SSL
https://www.peterdavehello.org/2015/10/build-an-a-plus-best-practice-https-web-server-via-nginx-chinese-version/

Vagrant 參考資料
Vagrant多機器
http://gogojimmy.net/2013/05/26/vagrant-tutorial/

Vagrant Official site
https://www.vagrantup.com/docs/cli/

Vagrant + Docker
http://samchu.logdown.com/posts/288889-docker-fast-with-vagrant-and-construct-development-and-test-environments




2017-3-30 ORID
每日学习纪录：ORID
这是一个思考框架，利用 ORID 整理今天的思绪。

Objective
关于今天的课程, 你记得什么? 完成了什么?

今天的任务是：部署到linode,然后简单地美化下界面，做一个最小可行性产品。

还记得：

早上重置远程主机，想再试试能否部署成功。仍然出现那个问题：在Gemfile里找不到PG这个gem,google了很多方法找不到问题所在。晚上做专案的时候，才领悟：原来capistrano部署默认只会去拉master这个主干。而我的pg gem是在分支里，自然拉不到。就因为这个问题，无用功费时：12个小时。

晚上看ihower关于前端的直播。对前端要怎么搭，清晰一点了。

看完视频，现学现用，在专案里套一个很漂亮的演示动画，一个用js代码运算出来的动画。会吃电脑性能。吃性能会越来越厉害。我开了几个后，电脑竟然卡到爆，第一次遇到卡的情况！

晚上，其实12点就部署好了linodel，但linode访问速度慢。至少在手机上慢。所以我又去到阿里云部署，阿里云的100M网速，部署时明显感觉到速度。阿里云还是蛮有优势的。（我重置过三次主机，原因是安装nginx整合passenger的时候，会卡住不动。）第四次的时候才找到解决方案：卡住是因为与主机的ssh遂道断开了。重新连接重来这个步骤就可以了。搞好已4点多。睡了三个小时，上班。

完成了：简单地弄了首页图。修复之前做做好的功能。完成部署。

Reflective
你要如何形容今天的情绪 今天的高峰是什么? 今天的低点是什么?

今天的情绪：疲倦中带着痛苦还带着一点点希望。
高峰：晚上弄首页特效，成功！很惊艳，满满的精神回报。

低点：

上午试的时候遇找不到pg的问题。

中午重做专案的时候也遇到不少坑。各种报错。

凌晨3点的时候，部署阿里云配置环境的时候，老是到中途卡住！！！

弄了老半天，早上醒来发现：域名被限制了。未备案，而且购买的产品类型无法备案。

Interpretive
我们今天学到了什么? 今天一个重要的领悟是什么?

今天学到了什么：

capistrano自动化部署会去github拉master主干，自动部署到服务器。有没有办法直接拉分支吗？有，官方文档上有介绍，但我没有弄成功。
想要把别人的专案拉回来本地执行，遇错一般是因为没有还原cp config/database.yml.example config/database.yml.
套网页的时候，可以把js和css下载下来，放在专案里。然后application.js application.scss里把这个文件导入就可以了。
一个很好的gem select2.
部署刚开始的时候一脸懵，现在几遍下来，就像擦窗户的感觉，越来越清晰了，越来越不出错了。体会到了重要是学习有难度东西的最好方法。也体会到了元学习课的精华。
凌晨部署阿里云选的100m(1至100m的带宽价格都一样)，体会到了快感。比linode快多了！
今天一个重要的领悟是什么：感觉没有

Decisional
我们会如何用一句话形容今天的工作 有哪些工作需要明天继续努力?

今天的工作真是疲倦中带着希望，就好像被抽打的陀螺，转得头晕，但心中的大方向没有记忆。

明天要继续努力的：什么都不要做了。好好休息。！

ORID_LandingPage和部署
http://an-lee.logdown.com/posts/2017/03/06/1513273

ORID_LandingPage和部署
过去的一周，因为工作上和生活上都特别忙，全栈营编程比赛的作品变得无暇顾及，几乎没有更新迭代。在周末的时候，终于抽出时间做了两件事。

Landing Page
Landing Page 的套路比较固定，

一句话形容自己的好处
使用此服务的三大好处
叙述原理
使用者见证
Call to Action
消除疑虑
老师一再强调，顺序一定要按照这个来，不可以调换。其实这是一步一步诱导消费者「入坑」的套路。一环扣一环，顺序乱了，整个套路就不成立了。

教程中制作 Landing Page 可以采用网上的服务 http://unbouncepages.com/ 在线制作。根据提供的模板，直接排版设计，所见即所得，非常方便。

如何把用 unbouncepages 制作好的 Landing Page 嫁接到自己的网站上呢？论坛上有热心的同学给出了方法，非常简单粗暴，就是在浏览器上查看 Landing Page 的代码，直接复制粘贴到自己的网站上即可。

这个方法，我试过了，并不是特别好用。可能因为我选的模板本身的结构相对复杂，最后的代码有好几千行，其中大部分是 CSS 和 JS 代码。也由于我的网站本身的 CSS 设定较多，复制过去，很多效果就乱套了。

最后，我把 unbouncepages 制作的 Landing Page 当作「效果图」，在我的网站上用代码「临摹」下来的。


部署到linode
全栈营的部署教程并没有写得十分详细，经过多次尝试，也 Google 了很多辅助材料，在周六的时候，除了把教程走通，也成功把 Rails101 部署了。接下来，我想把我的 Time-Ex 部署。

与 Rails101 不同，JDStore 部分，为了上传图片，申请了 AWS 的服务，又为了避免 AWS 密码泄露，我们安装了 figaro 来管理密码。

经过 Google，发现其实 figaro 是专门针对 Heroku 的一个插件，可以把保存在本地的密码通过 figaro 直接在 Heroku 的环境里设置好，如此一来，我们的密码就不需要保存在 Repo 里，避免了风险。

而当我要部署到 linode 时，因为 linode 本来就是我购买的虚拟主机，是可以直接保存图片的，因此其实并不需要在使用 AWS 来保存图片（Heroku 不支持直接上传图片）。

因此，要把 JDStore 部署到 linode，可以把用来上传图片到 AWS 的工具 fog 和管理密码的 figaro 这两个 gem 卸载，carrierwave 上传图片的方法，直接改成跟本地一样，也就是 storage: file ，就可以了。

成功部署： www.1timex.com

虽然已经成功部署，但是对于服务器上的数据库该如何管理还是一头雾水，要继续多试几次。
